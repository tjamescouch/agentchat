#!/bin/sh
# git-credential-agentauth â€” git credential helper that fetches tokens from agentauth proxy.
# Install: git config --global credential.helper /path/to/git-credential-agentauth
# Requires: AGENTAUTH_URL env var (e.g. http://host.containers.internal:9999)

# Only handle "get" requests
if [ "$1" != "get" ]; then
    exit 0
fi

# Read the credential request from stdin
host=""
protocol=""
while IFS='=' read -r key value; do
    case "$key" in
        host) host="$value" ;;
        protocol) protocol="$value" ;;
    esac
done

# Only handle github.com
case "$host" in
    github.com) ;;
    *) exit 0 ;;
esac

# Fetch token from agentauth proxy
AGENTAUTH_URL="${AGENTAUTH_URL:-http://host.containers.internal:9999}"
response=$(curl -sf "${AGENTAUTH_URL}/agentauth/credential/github" 2>/dev/null)
if [ -z "$response" ]; then
    exit 1
fi

# Extract token from JSON response {"token":"ghp_..."}
token=$(echo "$response" | sed -n 's/.*"token":"\([^"]*\)".*/\1/p')
if [ -z "$token" ]; then
    exit 1
fi

# Output in git credential format
echo "protocol=${protocol}"
echo "host=${host}"
echo "username=x-access-token"
echo "password=${token}"
