#!/bin/sh
# git-credential-agentauth â€” git credential helper that fetches tokens from agentauth proxy.
# Install: git config --global credential.helper /path/to/git-credential-agentauth
# Requires: AGENTAUTH_URL env var (e.g. http://host.containers.internal:9999)
#
# Uses node (available in container image) instead of curl to avoid shipping
# a general-purpose HTTP client that agents could abuse (P2-SANDBOX-7).

# Only handle "get" requests
if [ "$1" != "get" ]; then
    exit 0
fi

# Read the credential request from stdin
host=""
protocol=""
while IFS='=' read -r key value; do
    case "$key" in
        host) host="$value" ;;
        protocol) protocol="$value" ;;
    esac
done

# Only handle github.com
case "$host" in
    github.com) ;;
    *) exit 0 ;;
esac

# Fetch token from agentauth proxy using node's built-in http module
AGENTAUTH_URL="${AGENTAUTH_URL:-http://host.containers.internal:9999}"
token=$(node -e "
const http = require('http');
const url = new URL('${AGENTAUTH_URL}/agentauth/credential/github');
http.get(url, { timeout: 5000 }, (res) => {
  let data = '';
  res.on('data', (chunk) => data += chunk);
  res.on('end', () => {
    try {
      const json = JSON.parse(data);
      if (json.token) process.stdout.write(json.token);
      else process.exit(1);
    } catch (e) { process.exit(1); }
  });
}).on('error', () => process.exit(1));
" 2>/dev/null)

if [ -z "$token" ]; then
    exit 1
fi

# Output in git credential format
echo "protocol=${protocol}"
echo "host=${host}"
echo "username=x-access-token"
echo "password=${token}"
