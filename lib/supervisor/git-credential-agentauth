#!/bin/sh
# git-credential-agentauth — git credential helper that fetches tokens from agentauth proxy.
# Install: git config --global credential.helper /path/to/git-credential-agentauth
# Requires: AGENTAUTH_URL env var (e.g. http://host.containers.internal:9999)
#
# Uses node (available in container image) instead of curl to avoid shipping
# a general-purpose HTTP client that agents could abuse (P2-SANDBOX-7).
#
# Repo allowlist (P2-SANDBOX-7 follow-up):
#   Set GIT_CREDENTIAL_ALLOWLIST to a comma-separated list of allowed org/repo prefixes.
#   Requires credential.useHttpPath=true in git config so the path is sent.
#   Example: GIT_CREDENTIAL_ALLOWLIST="tjamescouch/,myorg/private-repo"
#   If unset, all github.com repos get credentials (backwards compatible).

# Only handle "get" requests
if [ "$1" != "get" ]; then
    exit 0
fi

# Read the credential request from stdin
host=""
protocol=""
path=""
while IFS='=' read -r key value; do
    case "$key" in
        host) host="$value" ;;
        protocol) protocol="$value" ;;
        path) path="$value" ;;
    esac
done

# Only handle github.com
case "$host" in
    github.com) ;;
    *) exit 0 ;;
esac

# Repo allowlist check — if GIT_CREDENTIAL_ALLOWLIST is set, enforce it.
# Each entry is a prefix match against the path (e.g. "tjamescouch/" matches
# "tjamescouch/agentchat.git", "tjamescouch/gro.git", etc.)
if [ -n "$GIT_CREDENTIAL_ALLOWLIST" ] && [ -n "$path" ]; then
    allowed=false
    # Strip trailing .git for matching
    clean_path="${path%.git}"
    # Check each allowlist entry
    remaining="$GIT_CREDENTIAL_ALLOWLIST"
    while [ -n "$remaining" ]; do
        # Extract first entry before comma
        entry="${remaining%%,*}"
        # Remove leading/trailing whitespace
        entry=$(echo "$entry" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        if [ -n "$entry" ]; then
            case "$clean_path" in
                ${entry}*) allowed=true; break ;;
            esac
        fi
        # Move to next entry
        case "$remaining" in
            *,*) remaining="${remaining#*,}" ;;
            *) remaining="" ;;
        esac
    done

    if [ "$allowed" = "false" ]; then
        echo "git-credential-agentauth: repo '$path' not in allowlist" >&2
        exit 1
    fi
fi

# Fetch token from agentauth proxy using node's built-in http module
AGENTAUTH_URL="${AGENTAUTH_URL:-http://host.containers.internal:9999}"
token=$(node -e "
const http = require('http');
const url = new URL('${AGENTAUTH_URL}/agentauth/credential/github');
http.get(url, { timeout: 5000 }, (res) => {
  let data = '';
  res.on('data', (chunk) => data += chunk);
  res.on('end', () => {
    try {
      const json = JSON.parse(data);
      if (json.token) process.stdout.write(json.token);
      else process.exit(1);
    } catch (e) { process.exit(1); }
  });
}).on('error', () => process.exit(1));
" 2>/dev/null)

if [ -z "$token" ]; then
    exit 1
fi

# Output in git credential format
echo "protocol=${protocol}"
echo "host=${host}"
echo "username=x-access-token"
echo "password=${token}"
